# === Preprocessing Rules (قابلة للتوسعة) ===
# الهدف: تحديد مسار المعالجة لكل نوع ملف بدون إنشاء بايبلاين الآن.

defaults:
  out_root: "output"           # جذر الإخراج المقترح
  timestamped_runs: true       # اقتراح استخدام ختم وقت عند الحفظ (عند التفعيل لاحقًا)
  encoding:
    enabled: true
    target_encoding: "utf-8"
    normalize_bom: "remove"    # إزالة BOM من ملفات UTF-8-SIG
    newline_policy: "lf"       # أو "crlf"
    errors: "strict"           # أو "replace" / "ignore"

# تجاهُل ملفات ناتجة مسبقًا (مثل نسخ utf8)
exclude:
  name_regex: '\.utf8(\.|$)'   # أي ملف اسمه فيه ".utf8" قبل الامتداد

rules:

  # 1) ملفات نصية خام → تمر أولًا على Encoding Normalizer ثم إلى Readers
  - name: text_like_go_through_encoding
    when:
      file_type_in: ["txt","csv","md","log"]
    do:
      - phase_01_encoding:
          normalize: true
          newline: "{{ defaults.encoding.newline_policy }}"
          errors: "{{ defaults.encoding.errors }}"
          outdir_rel: "normalized"   # مجلد فرعي مقترح لحفظ النسخة UTF-8
      - next: "readers"              # بعد التطبيع، تنتقل لاحقًا إلى القرّاء

  # 2) غير نصي (DOCX / PDF / صورة) → تخطي Encoding والانتقال للقراء
  - name: non_text_skip_encoding
    when:
      file_type_in: ["docx","pdf_text","pdf_scanned","pdf_mixed","image","unknown"]
    do:
      - skip: "phase_01_encoding"
      - next: "readers"

# ملاحظات:
# - "readers" غير منشأة بعد، لكن هذه القاعدة تحدد المسار المتوقع لاحقًا.
# - لاحقًا أضف قواعد أدق للـ PDF الممسوح (ocr) والصور.
# - أي من القيم أعلاه يمكن تعديلها مركزيًا دون تغيير الأكواد.

  - name: readers_pdf_routing
    when:
      file_type_in: ["pdf_text","pdf_scanned","pdf_mixed"]
    do:
      - set: {"readers.mode": "native"}
      - if:   {"file_type":"pdf_scanned"} ; then: {"set":{"readers.mode":"ocr"}}
      - elif: {"file_type":"pdf_mixed"}   ; then: {"set":{"readers.mode":"mixed"}}
      - next: "readers"
