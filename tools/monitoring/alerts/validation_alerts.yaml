groups:
  - name: medflux-validation
    rules:
      - alert: MedfluxValidationFailRateHigh
        expr: |
          medflux_validation_fail_rate > 0.05
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Validation fail rate high (>5%)"
          description: "{{ $labels.phase }} {{ $labels.kind }} fail rate > 5% for 10m."
      - alert: MedfluxPhaseErrorsHigh
        expr: sum(rate(medflux_phase_runs_total{status="error"}[10m])) by (phase) > 0
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Phase errors detected"
          description: "Phase {{ $labels.phase }} has errors in the last 10 minutes."

      # SLO-style burn-rate alerts (target success 98% => error budget 2%)
      - alert: MedfluxValidationSLOBurnFast
        expr: |
          (
            sum(rate(medflux_validation_failed_total[5m]))
              /
            (sum(rate(medflux_validation_failed_total[5m])) + sum(rate(medflux_validation_ok_total[5m])))
          ) / 0.02 > 5
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Validation SLO fast burn"
          description: |
            Error budget burning fast: 5m fail rate / budget > 5x for 10m.

      - alert: MedfluxValidationSLOBurnSlow
        expr: |
          (
            sum(rate(medflux_validation_failed_total[1h]))
              /
            (sum(rate(medflux_validation_failed_total[1h])) + sum(rate(medflux_validation_ok_total[1h])))
          ) / 0.02 > 1
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Validation SLO slow burn"
          description: |
            Error budget burning: 1h fail rate / budget > 1x for 1h.

      - alert: MedfluxValidationLatencyP95High
        expr: |
          histogram_quantile(
            0.95,
            sum(rate(medflux_validation_duration_ms_bucket[10m])) by (le)
          ) > 2000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Validation p95 latency high"
          description: "p95 > 2s over 10m"
