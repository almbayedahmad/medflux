# === Preprocessing Rules (Extensible) ===
# Goal: define the processing path for each file type without building the pipeline yet.
# Sections:
#   defaults  - global knobs (output roots, encoding policies)
#   exclude   - helper filters that skip already-normalized assets
#   rules     - ordered decision table describing how documents flow across phases

defaults:
  out_root: "output"           # Suggested output root
  timestamped_runs: true       # Recommend timestamping saved runs when enabled later
  encoding:
    enabled: true
    target_encoding: "utf-8"
    normalize_bom: "remove"    # Remove BOM from UTF-8-SIG files
    newline_policy: "lf"       # or "crlf"
    errors: "strict"           # or "replace" / "ignore"

# Ignore previously generated files (such as utf8 copies)
exclude:
  name_regex: '\.utf8(\.|$)'   # Any filename containing ".utf8" before the extension

rules:

  # 1) Raw text files -> run through Encoding Normalizer before Readers
  - name: text_like_go_through_encoding
    when:
      file_type_in:
        - txt
        - csv
        - md
        - log
    do:
      - phase_01_encoding:
          normalize: true
          newline: "{{ defaults.encoding.newline_policy }}"
          errors: "{{ defaults.encoding.errors }}"
          outdir_rel: "normalized"   # Proposed subfolder for the UTF-8 copy
      - next: "readers"              # After normalization, move on to readers

  # 2) Non-text (DOCX / PDF / image) -> skip encoding and go to readers
  - name: non_text_skip_encoding
    when:
      file_type_in:
        - docx
        - pdf_text
        - pdf_scanned
        - pdf_mixed
        - image
        - unknown
    do:
      - skip: "phase_01_encoding"
      - next: "readers"

# Notes:
# - "readers" pipeline not implemented yet; this rule defines the expected path.
# - Later add finer rules for scanned PDFs (OCR) and images.
# - Any value above can be adjusted centrally without changing code.

  - name: readers_pdf_routing
    when:
      file_type_in:
        - pdf_text
        - pdf_scanned
        - pdf_mixed
    do:
      - set:
          "readers.mode": "native"
      - if:
          file_type: pdf_scanned
        then:
          set:
            "readers.mode": "ocr"
      - elif:
          file_type: pdf_mixed
        then:
          set:
            "readers.mode": "mixed"
      - next: "readers"
